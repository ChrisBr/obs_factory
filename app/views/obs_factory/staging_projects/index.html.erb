<div class="grid_13 alpha">
  <div class="box box-shadow">

    <table class="dashboard" id="staging-dashboard">
      <thead>
      <tr>
        <th>Project</th>
        <th>Requests</th>
        <th>Problems</th>
      </tr>
      </thead>
      <tbody>
      <%- @staging_projects.each do |project| %>
          <% next if project.overall_state == :empty %>
          <tr>
            <td>
              <div class="project state-<%= project.overall_state %>">
                <div class="letter"><%= link_to project.letter, staging_project_path(project.id) %></div>
                <div class="state"><%= link_to project.overall_state, main_app.project_show_path(project.name) %></div>
                <div class="progress">
                  <% if project.overall_state == :building %>
                      <% progress = project.build_progress %>
                      <%= link_to main_app.project_monitor_url(progress[:subproject]) do %>
                          <%= progress[:percentage] %>%
                      <% end %>
                  <% elsif project.overall_state == :review %>
                      <%= project.review_percentage %>%
                  <% elsif project.overall_state == :testing %>
                      <%= link_to project.first_running_openqa_job_link do %>
                          <%= project.testing_percentage %>%
                      <% end %>
                  <% end %>
                </div>
              </div>
            </td>
            <td>
              <ul class="packages-list">
                <% project.classified_requests.each do |r| %>
                    <li class="<%= r[:css] %> request">
                      <%= link_to r[:package], main_app.request_show_path(r[:id]) %>

                      <% r[:missing_reviews].each do |mr| %>
                          <%= link_to sprite_tag(mr[:icon]), main_app.request_show_path(r[:id]) %>
                      <% end if r[:missing_reviews].present? %>
                    </li>
                <% end -%>
              </ul>

            </td>
            <td class="broken-packages">
              <% problems = []
                 if project.overall_state != :building
                   problems += project.failed_openqa_jobs.map { |j| "<li class='openqa_job'>QA: " + render(j) + "</li>" }
                 end
              -%>

              <% project.broken_packages.each do |pack|
                line = "<li class='failed_pkg status_#{pack['state']}'>"
                if pack['state'] == 'failed'
                  link = main_app.package_live_build_log_url(project: pack['project'], package: pack['package'], repository: pack['repository'], arch: pack['arch'])
                else
                  link = main_app.package_show_url(pack['project'], pack['package'])
                end
                line += link_to "Build #{pack['state']}: #{pack['package']}", link
                line += "</li>"
                problems << line
              end -%>

              <% if problems.present? %>
                  <% counter = 0 %>
                  <ul class='problem_list'>
                    <% problems.sort.each do |p| %>
                        <%= p.html_safe %>
                        <% counter += 1 %>
                        <% if counter > 3 && problems.size != 4 %>
                            <li>...<%= problems.size - counter %> more problems</li>
                        <% end %>
                    <% end %>
                  </ul>
              <% else %>
                  <%= sprite_tag('accept', alt: 'OK') %>
              <% end %>
            </td>
          </tr>
      <% end %>
      </tbody>
    </table>

  </div>
</div>

<div class="grid_3 omega">
  <div class="box box-shadow">
    <h2 class="box-header">Legend</h2>

    <p>Requests</p>
    <ul class="color-legend">
      <li><span class="ok"></span>Ready</li>
      <li><span class="review"></span>In review</li>
      <li><span class="obsolete"></span>Obsolete</li>
      <li><span class="untracked"></span>Untracked</li>
    </ul>

    <p>Projects</p>
    <ul class="color-legend">
      <li><span class="project state-building"></span>Building</li>
      <li><span class="project state-testing"></span>Testing</li>
      <li><span class="project state-review"></span>Review</li>
      <li><span class="project state-acceptable"></span>Acceptable</li>
      <li><span class="project state-unacceptable"></span>Unacceptable</li>
      <li><span class="project state-failed"></span>Failed</li>
    </ul>
  </div>

  <div class="box box-shadow">
    <h2 class="box-header">Infos</h2>

    <p>Empty Projects:</p>
    <% empties = @staging_projects.select { |p| p.overall_state == :empty }.map { |p| p.letter } %>

    <p>
      <% if empties.empty? %>
          none
      <% else %>
          <%= empties.sort.join(' &dash; ').html_safe %>
      <% end %>
    </p>

    <p>Backlog:</p>
    <% if @backlog_requests.empty? %>
        <p><i>Empty</i></p>
    <% else %>
        <ul class="staging_backlog">
          <% counter = 0
             @backlog_requests.each do |req| %>
              <li>
                <%= link_to elide(req.package, length = 19), main_app.request_show_path(req.id) %>
              </li>
              <% counter += 1
                 if counter > 5 %>
                  <li>... <%= @backlog_requests.size - counter %> more</li>
                  <% break %>
              <% end %>
          <% end %>
        </ul>
    <% end %>
  </div>
</div>
